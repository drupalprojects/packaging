<?php

/**
 * @file
 * Packaging Unit tests.
 */

/**
 * SimpleTests for Packaging.
 */
class PackagingUnitTestCase extends DrupalUnitTestCase {

  protected $products = array();

  public static function getInfo() {
    return array(
      'name' => 'Packaging',
      'description' => 'Test Packaging.',
      'group' => 'Packaging',
    );
  }

  /**
   * Overrides DrupalUnitTestCase::setUp().
   */
  function setUp() {
    parent::setUp();

    // Load all files needed for these Unit tests.
    $this->loadIncludes();

    // Create test products for packaging.
    $this->products = $this->createTestProducts();
    //debug($this->products);
  }

  /**
   * Test "All-in-one" packaging, where all products are put into one package
   * subject only to package maximum weight.  If maximum weight is exceeded,
   * a new package is created.
   */
  function testPackageAllInOne() {
    $this->pass(t('Testing PackageAllInOne strategy'));

    $strategy = new PackageAllInOne();
    $strategy->setMaximumPackageWeight(15);
    $strategy->setDefaultWeightUnits('LB');
    $strategy->setWeightMarkupFunction('packaging_weight_markup');

    $packages = $strategy->packageProducts($this->products);

    //debug($packages);

    // Product aggregates.
    $product_aggregate = $this->getProductAggregate($strategy, $this->products);

    // Package aggregates.
    $package_aggregate = $this->getPackageAggregate($strategy, $packages);

    // Test to see if the strategy produced the expected total weight.
    $this->assertTrue(
      abs((float) $package_aggregate->getWeight() - (float) $product_aggregate->getWeight()) < 0.0001,
      t('Total weight of packages equals total weight of products.')
    );

    // Test to see if the strategy produced the expected weight markup.
    $this->assertTrue(
      abs((float) $package_aggregate->getShipWeight() - (float) packaging_weight_markup((float) $product_aggregate->getWeight())) < 0.0001,
      t('Ship weight of packages equals total weight of products with markup.')
    );

    // Actual number of boxes.
    $actual_number_of_packages = count($packages);

    // Test different origin addresses
    // Test different destination addresses

    // Test effect of maximum package weight

    // Test effect of package quantity
  }

  /**
   * Test Each in Own packaging.
   */
  function testPackageEachInOwn() {
    $this->pass(t('Testing PackageEachInOwn strategy'));

    $strategy = new PackageEachInOwn();
    $strategy->setMaximumPackageWeight(15);
    $strategy->setDefaultWeightUnits('LB');
    $strategy->setWeightMarkupFunction('packaging_weight_markup');

    $packages = $strategy->packageProducts($this->products);

    //debug($packages);

    // Product aggregates.
    $product_aggregate = $this->getProductAggregate($strategy, $this->products);

    // Package aggregates.
    $package_aggregate = $this->getPackageAggregate($strategy, $packages);

    // Test to see if the strategy produced the expected total weight.
    $this->assertTrue(
      abs((float) $package_aggregate->getWeight() - (float) $product_aggregate->getWeight()) < 0.0001,
      t('Total weight of packages equals total weight of products.')
    );

    // Test to see if the strategy produced the expected weight markup.
    $this->assertTrue(
      abs((float) $package_aggregate->getShipWeight() - (float) packaging_weight_markup((float) $product_aggregate->getWeight())) < 0.0001,
      t('Ship weight of packages equals total weight of products with markup.')
    );

    // Actual number of boxes.
    $actual_number_of_packages = count($packages);

    // Calculate expected number of boxes.
    $expected_number_of_packages = 0;
    foreach ($this->products as $product) {
      $expected_number_of_packages += ceil($product->getQuantity() / $product->getPackageQuantity());
    }

    // Test to see if the strategy produced the expected number of boxes.
    $this->assertTrue(
      ($actual_number_of_packages == $expected_number_of_packages),
      t('Number of packages equals expectation.')
    );
  }

  /**
   * Test One package strategy.
   */
  function testPackageOnePackage() {
    $this->pass(t('Testing PackageOnePackage strategy'));

    $strategy = new PackageOnePackage();
    $strategy->setMaximumPackageWeight(15);
    $strategy->setDefaultWeightUnits('LB');
    $strategy->setWeightMarkupFunction('packaging_weight_markup');

    $packages = $strategy->packageProducts($this->products);

    //debug($packages);

    // Product aggregates.
    $product_aggregate = $this->getProductAggregate($strategy, $this->products);

    // Package aggregates.
    $package_aggregate = $this->getPackageAggregate($strategy, $packages);

    // Test to see if the strategy produced the expected total weight.
    $this->assertTrue(
      abs($package_aggregate->getWeight() - $product_aggregate->getWeight()) < 0.0001,
      t('Total weight of packages equals total weight of products.')
    );

    // Test to see if the strategy produced the expected weight markup.
    $this->assertTrue(
      abs($package_aggregate->getShipWeight() - packaging_weight_markup($product_aggregate->getWeight())) < 0.001,
      t('Ship weight of packages equals total weight of products with markup.')
    );

    // Actual number of boxes.
    $actual_number_of_packages = count($packages);

    // Calculate expected number of boxes.
    $expected_number_of_packages = 1;

    // Test to see if the strategy produced the expected number of boxes.
    $this->assertTrue(
      ($actual_number_of_packages == $expected_number_of_packages),
      t('Number of packages equals expectation.')
    );
  }

  /**
   * Test package by volume strategy.
   */
  function testPackageAverageWeight() {
    $this->pass(t('Testing PackageAverageWeight strategy'));

    $strategy = new PackageAverageWeight();
    $strategy->setMaximumPackageWeight(15);
    $strategy->setDefaultWeightUnits('LB');
    $strategy->setWeightMarkupFunction('packaging_weight_markup');

    $packages = $strategy->packageProducts($this->products);

    //debug($packages);

    // Product aggregates.
    $product_aggregate = $this->getProductAggregate($strategy, $this->products);

    // Package aggregates.
    $package_aggregate = $this->getPackageAggregate($strategy, $packages);

    // Test to see if the strategy produced the expected total weight.
    $this->assertTrue(
      abs($package_aggregate->getWeight() - $product_aggregate->getWeight()) < 0.0001,
      t('Total weight of packages equals total weight of products.')
    );

    // Test to see if the strategy produced the expected weight markup.
    $this->assertTrue(
      abs($package_aggregate->getShipWeight() - packaging_weight_markup($product_aggregate->getWeight())) < 0.0001,
      t('Ship weight of packages equals total weight of products with markup.')
    );

    // Actual number of boxes.
    $actual_number_of_packages = count($packages);

    // Calculate expected number of boxes.
    $expected_number_of_packages = ceil($product_aggregate->getWeight() / $strategy->getMaximumPackageWeight());

    // Test to see if the strategy produced the expected number of boxes.
    $this->assertTrue(
      ($actual_number_of_packages == $expected_number_of_packages),
      t('Number of packages equals expectation.')
    );
  }

  /**
   * Test package by volume strategy.
   */
  function junktestPackageByVolume() {
    $this->pass(t('Testing PackageByVolume strategy'));

    $strategy = new PackageByVolume();
    $strategy->setMaximumPackageWeight(15);
    $strategy->setDefaultWeightUnits('LB');
    $strategy->setWeightMarkupFunction('packaging_weight_markup');

    $packages = $strategy->packageProducts($this->products);

    //debug($packages);

    // Product aggregates.
    $product_aggregate = $this->getProductAggregate($strategy, $this->products);

    // Package aggregates.
    $package_aggregate = $this->getPackageAggregate($strategy, $packages);

    // Test to see if the strategy produced the expected total weight.
    $this->assertTrue(
      abs($package_aggregate->getWeight() - $product_aggregate->getWeight()) < 0.0001,
      t('Total weight of packages equals total weight of products.')
    );

    // Test to see if the strategy produced the expected weight markup.
    $this->assertTrue(
      abs($package_aggregate->getShipWeight() - packaging_weight_markup($product_aggregate->getWeight())) < 0.0001,
      t('Ship weight of packages equals total weight of products with markup.')
    );

  }

  /**
   * Test custom strategy.
   */
  function testPackageCustomStrategy() {
    // Test plugin system to see that any custom plugin gets picked up.
    // PackageCustomStrategy is defined by the packaging_test module.
    $this->pass(t('Testing PackageCustomStrategy strategy'));
  }


  /****************************************************************************
   * Utility Functions                                                        *
   ****************************************************************************/


  /**
   * Loads needed include files.
   */
  function loadIncludes() {
    drupal_load('module', 'packaging');
    drupal_load('module', 'uc_store');
    module_load_include('inc', 'packaging', 'classes/package');
    module_load_include('inc', 'packaging', 'classes/product');
    module_load_include('inc', 'packaging', 'classes/strategy');
    module_load_include('inc', 'packaging', 'strategies/package_each_in_own.strategy');
    module_load_include('inc', 'packaging', 'strategies/package_all_in_one.strategy');
    module_load_include('inc', 'packaging', 'strategies/package_one_package.strategy');
    module_load_include('inc', 'packaging', 'strategies/package_average_volume.strategy');
    module_load_include('inc', 'packaging', 'strategies/package_by_volume.strategy');
    module_load_include('inc', 'packaging', 'strategies/package_average_weight.strategy');
  }

  /**
   * Returns a Product object containing aggregate information.
   */
  function getProductAggregate(PackagingStrategy $strategy, array $products) {
    $product_aggregate = new Product();
    $product_aggregate->setWeightUnits($strategy->getDefaultWeightUnits());
    foreach ($this->products as $product) {
      $product_aggregate->setWeight($product_aggregate->getWeight() + $product->getQuantity() * $product->getWeight() * uc_weight_conversion($product->getWeightUnits(), $strategy->getDefaultWeightUnits()));
      $product_aggregate->setQuantity($product_aggregate->getQuantity() + $product->getQuantity());
    }
    $this->pass(t('Total weight of products = %total %units.', array('%total' => $product_aggregate->getWeight(), '%units' => $strategy->getDefaultWeightUnits())));

    return $product_aggregate;
  }

  /**
   * Returns a Package object containing aggregate information.
   */
  function getPackageAggregate(PackagingStrategy $strategy, array $packages) {
    $package_aggregate = new Package();
    $package_aggregate->setWeightUnits($strategy->getDefaultWeightUnits());
    foreach ($packages as $package) {
      $package_aggregate->setWeight($package_aggregate->getWeight() + $package->getWeight());
      $package_aggregate->setShipWeight($package_aggregate->getShipWeight() + $package->getShipWeight());
      $package_aggregate->setQuantity($package_aggregate->getQuantity() + $package->getQuantity());
    }
    $this->pass(t('Total package weight = %total %units.', array('%total' => $package_aggregate->getWeight(), '%units' => $strategy->getDefaultWeightUnits())));
    //$this->pass(t('Total package weight after weight markup = %total %units.', array('%total' => $package_aggregate->getShipWeight(), '%units' => $strategy->getDefaultWeightUnits()))); *uc_weight_markup
    $this->pass(t('Total ship weight of packages = %total %units.', array('%total' => $package_aggregate->getShipWeight(), '%units' => $strategy->getDefaultWeightUnits())));

    return $package_aggregate;
  }

  /**
   * Creates a new product.
   */
  function createTestProducts() {
    $products = array();
    $number = mt_rand(5, 10);
    for ($i = 0; $i < $number; $i++) {
      $products[] = Product::constructFromUbercartProduct($this->createProduct());
    }
    return $products;
  }

  /**
   * Creates a new product.
   */
  function createProduct($product = array()) {
    // Set the default required fields.
    $weight_units = array('lb', 'kg', 'oz', 'g');
    $length_units = array('in', 'ft', 'cm', 'mm');
    $product += array(
      'type' => 'product',
      'model' => $this->randomName(8),
      'list_price' => mt_rand(1, 9999),
      'cost' => mt_rand(1, 9999),
      'sell_price' => mt_rand(1, 9999),
      'weight' => mt_rand(1, 5),
      'weight_units' => array_rand(array_flip($weight_units)),
      'length' => mt_rand(1, 9999),
      'width' => mt_rand(1, 9999),
      'height' => mt_rand(1, 9999),
      'length_units' => array_rand(array_flip($length_units)),
      'pkg_qty' => mt_rand(1, 10),
      'default_qty' => 1,
      'qty' => mt_rand(1,5),
      'ordering' => mt_rand(-25, 25),
      'shippable' => TRUE,
    );

    return (object) $product;
  }
}
